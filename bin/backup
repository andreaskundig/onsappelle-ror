#!/bin/bash
set -e

# Configuration
BUCKET="onsap"
DB_PATH="/rails/storage/production.sqlite3"
BACKUP_NAME="backup-$(date +%Y-%m-%d-%H%M%S).sqlite3"
RETENTION_DAYS=30

# Create temporary backup
cp "$DB_PATH" "/tmp/$BACKUP_NAME"

# Upload to R2
rclone copy "/tmp/$BACKUP_NAME" "r2:$BUCKET/"

# Clean up local temp file
rm "/tmp/$BACKUP_NAME"

# Delete old backups (older than RETENTION_DAYS)
rclone delete "r2:$BUCKET/" --min-age ${RETENTION_DAYS}d --include "backup-*.sqlite3"

echo "Backup completed: $BACKUP_NAME"
